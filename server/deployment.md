# Deployment

The following are instructions for deploying the API server (which will run on `https://api.wety.org`) on a fresh [Oracle Cloud ARM instance](https://docs.oracle.com/en-us/iaas/Content/Compute/References/arm.htm) running Ubuntu. This assumes one has already spun an instance up and has `ssh`ed into it. This also assumes that [`wety-client`](https://github.com/jmviz/wety-client) is being served separately on `https://wety.org` (e.g. through github pages), and that one's domain registrar's DNS records are set up properly for github pages and to point the `api` subdomain to the IP address of the Oracle Cloud instance. These instructions are mainly for my (jmviz) own reference. If you are trying to follow these yourself, you should of course substitute whatever your own domain(s) are that you want to have running the client and API server(s). 

## Install Rust

Install Rust:

```bash
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
```

Install nightly Rust:

```bash
rustup toolchain install nightly
```

Make nightly the default:

```bash
rustup default nightly
```

## Install required packages

Add some required packages:

```bash
sudo apt install build-essential pkg-config libssl-dev cmake
```

## Install PyTorch

Usually one can follow [the manual installation instructions on `rust-bert`'s docs](https://docs.rs/rust-bert/0.20.0/rust_bert/#manual-installation-recommended). However, on an Oracle Cloud ARM instance, we have to build PyTorch from source. To build from source for Ubuntu aarch64 with CPU-only (loosely following [the instructions on the PyTorch repo](https://github.com/pytorch/pytorch#from-source)):

```bash
cd
sudo apt install python3 python3-pip python-is-python3 ninja-build
git clone --branch v1.13.1 https://github.com/pytorch/pytorch.git pytorch-1.13.1
cd pytorch-1.13.1
git submodule update --init --recursive
pip install -r requirements.txt
python setup.py develop
```

The compilation will take a while. Once it's done, add the following to ~/.bashrc:

```bash
export LIBTORCH=~/pytorch-1.13.1/torch
export LD_LIBRARY_PATH=${LIBTORCH}/lib:$LD_LIBRARY_PATH
```

and run:

```bash
source ~/.bashrc
```

At this point, `wety` should be compilable. However, for it to actually work, we need to set up some networking.

## Open up ports

On the Oracle Cloud administration page for your instance, follow [these instructions](https://docs.oracle.com/en-us/iaas/developer-tutorials/tutorials/apache-on-ubuntu/01oci-ubuntu-apache-summary.htm#add-ingress-rules) to add an ingress rule for port 80 HTTP, and also do the same for port 443 (HTTPS). Then, in your `ssh` session:

```bash
sudo apt install firewalld
sudo firewall-cmd --permanent --zone=public --add-port=80/tcp
sudo firewall-cmd --permanent --zone=public --add-port=443/tcp
sudo firewall-cmd --reload
```

## Set up SSL certification

We will use CertBot to get free SSL certification so API requests can be made through HTTPS, following [these directions](https://certbot.eff.org/instructions?ws=other&os=ubuntufocal) (`snap` should already be installed, so skip that part):

```bash
sudo snap install core; sudo snap refresh core
sudo apt remove certbot
sudo snap install --classic certbot
sudo ln -s /snap/bin/certbot /usr/bin/certbot
sudo certbot certonly --standalone
```

Follow the prompts generated by the final command. When it prompts you for the domain, input `api.wety.org`. The certificate and private key should be saved at:

```bash
/etc/letsencrypt/live/api.wety.org/fullchain.pem
/etc/letsencrypt/live/api.wety.org/privkey.pem
```

They should also automatically renew as needed. We need to change permissions so that the `wety` process can read them (cf. [here](https://stackoverflow.com/a/54903098/10658294)). (Replace `ubuntu` with whatever the result of `whoami` is):

```bash
sudo addgroup wetycert
sudo adduser ubuntu wetycert
sudo adduser root wetycert
sudo chgrp -R wetycert /etc/letsencrypt/live
sudo chgrp -R wetycert /etc/letsencrypt/archive
sudo chmod -R 750 /etc/letsencrypt/live
sudo chmod -R 750 /etc/letsencrypt/archive
```


(for the rest of the steps in this section, cf. [here](https://blogs.oracle.com/developers/post/free-ssl-certificates-in-the-oracle-cloud-using-certbot-and-lets-encrypt)):




To set up automatic server shutdown/restart on renewal: TODO.


## Set up port forwarding

Forward incoming HTTPS traffic on port 443 to port 3000, where the server listens (cf. [here](https://superuser.com/a/1334552)): 

```bash
sudo iptables -t nat -I PREROUTING -p tcp --dport 443 -j REDIRECT --to-ports 3000
sudo netfilter-persistent save
```




