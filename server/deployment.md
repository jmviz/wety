# Deployment

The following are instructions for deploying the API server (which will run on `https://api.wety.org`) on a fresh [Oracle Cloud ARM instance](https://docs.oracle.com/en-us/iaas/Content/Compute/References/arm.htm) running Ubuntu. This assumes one has already spun an instance up and has `ssh`ed into it. This also assumes that [`wety-client`](https://github.com/jmviz/wety-client) is being served separately on `https://wety.org` (e.g. through github pages), and that one's domain registrar's DNS records are set up properly for github pages and to point the `api` subdomain to the IP address of the Oracle Cloud instance. These instructions are mainly for my (jmviz) own reference. If you are trying to follow these yourself, you should of course substitute whatever your own domain(s) are that you want to have running the client and API server(s).

## Install Rust

Install Rust:

```bash
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
```

Install nightly Rust:

```bash
rustup toolchain install nightly
```

Make nightly the default:

```bash
rustup default nightly
```

## Install required packages

Add some required packages:

```bash
sudo apt install build-essential pkg-config libssl-dev cmake
```

## Install PyTorch

Usually one can follow [the manual installation instructions on `rust-bert`'s docs](https://docs.rs/rust-bert/0.20.0/rust_bert/#manual-installation-recommended). However, on an Oracle Cloud ARM instance, we have to build PyTorch from source. To build from source for Ubuntu aarch64 with CPU-only (loosely following [the instructions on the PyTorch repo](https://github.com/pytorch/pytorch#from-source)):

```bash
cd
sudo apt install python3 python3-pip python-is-python3 ninja-build
git clone --branch v1.13.1 https://github.com/pytorch/pytorch.git pytorch-1.13.1
cd pytorch-1.13.1
git submodule update --init --recursive
pip install -r requirements.txt
python setup.py develop
```

The compilation will take a while. Once it's done, add the following to ~/.bashrc:

```bash
export LIBTORCH=~/pytorch-1.13.1/torch
export LD_LIBRARY_PATH=${LIBTORCH}/lib:$LD_LIBRARY_PATH
```

and run:

```bash
source ~/.bashrc
```

At this point, `wety` should be compilable, which you should now do with:

```bash
cd ~/wety
cargo build --release
```

However, for the server to actually work, we need to set up some networking.

## Set up ports

On the Oracle Cloud administration page for your instance, follow [these instructions](https://docs.oracle.com/en-us/iaas/developer-tutorials/tutorials/apache-on-ubuntu/01oci-ubuntu-apache-summary.htm#add-ingress-rules) to add an ingress rule for port 80 HTTP, and also do the same for port 443 (HTTPS). Then, in your `ssh` session:

```bash
sudo apt install firewalld
sudo firewall-cmd --permanent --zone=public --add-port=80/tcp
sudo firewall-cmd --permanent --zone=public --add-port=443/tcp
sudo firewall-cmd --permanent --zone=public --add-forward-port=port=443:proto=tcp:toport=3000
sudo firewall-cmd --reload
```

The third rule above forwards HTTPS traffic on 443 to 3000, where the `wety` server listens.

## Set up SSL certification

We will use Certbot to get free SSL certification so API requests can be made through HTTPS, following [these directions](https://certbot.eff.org/instructions?ws=other&os=ubuntufocal) (`snap` should already be installed, so skip that part):

```bash
sudo snap install core; sudo snap refresh core
sudo apt remove certbot
sudo snap install --classic certbot
sudo ln -s /snap/bin/certbot /usr/bin/certbot
sudo certbot certonly --standalone
```

Follow the prompts generated by the final command. When it prompts you for the domain, input `api.wety.org`. The certificate and private key should be saved at:

```bash
/etc/letsencrypt/live/api.wety.org/fullchain.pem
/etc/letsencrypt/live/api.wety.org/privkey.pem
```

We need to move the certs and change their permissions so they can be accessed (replace `ubuntu` with whatever the result of `whoami` is):

```bash
mkdir ~/certs
sudo cp /etc/letsencrypt/live/api.wety.org/{fullchain,privkey}.pem ~/certs/
sudo chown ubuntu ~/certs/{fullchain,privkey}.pem
```

The certification will expire in 90 days. At some point before that, Certbot should do an automatic renewal. To rerun this last step and restart the wety service after successful renewal, we create a deploy hook which will run after Certbot successfully renews the certification. Create the file:

```bash
sudo nano /etc/letsencrypt/renewal-hooks/deploy/copy-certs
```

And write the following to it:

```bash
#!/bin/bash
sudo cp /etc/letsencrypt/live/api.wety.org/{fullchain,privkey}.pem ~/certs/
sudo chown ubuntu ~/certs/{fullchain,privkey}.pem
sudo systemctl restart wety
```

After saving, make it executable:

```bash
sudo chmod +x /etc/letsencrypt/renewal-hooks/deploy/copy-certs
```

The last few steps were adapted from [here](https://blogs.oracle.com/developers/post/free-ssl-certificates-in-the-oracle-cloud-using-certbot-and-lets-encrypt). See also the [official documentation](https://eff-certbot.readthedocs.io/en/stable/using.html#renewing-certificates).

## Set up systemd service

To ensure that the server starts automatically on boot, we set up a systemd service.

Create the service unit file:

```bash
sudo nano /etc/systemd/system/wety.service
```

In the editor, enter the following content for the service unit file:

```
[Unit]
Description=wety server
After=network.target

[Service]
Environment=LIBTORCH=/home/ubuntu/pytorch-1.13.1/torch
Environment=LD_LIBRARY_PATH=/home/ubuntu/pytorch-1.13.1/torch/lib
Environment=WETY_ENVIRONMENT=production
Environment=WETY_CERT_PATH=/home/ubuntu/certs/fullchain.pem
Environment=WETY_KEY_PATH=/home/ubuntu/certs/privkey.pem
User=ubuntu
WorkingDirectory=/home/ubuntu/wety
ExecStart=/home/ubuntu/wety/target/release/server
Restart=always

[Install]
WantedBy=multi-user.target
```

Save the file and exit the editor.

Set the appropriate permissions for the service unit file:

```bash
sudo chmod 644 /etc/systemd/system/wety.service
```

Reload the systemd daemon to recognize the new service:

```bash
sudo systemctl daemon-reload
```

Enable the service to start on boot:

```bash
sudo systemctl enable wety.service
```

Start the service:

```bash
sudo systemctl start wety.service
```

Finished!

# Management

## Updating the server binary from remote

```bash
cd ~/wety
git pull
cargo build --release
sudo systemctl restart wety
```

## Managing the systemd service

To debug if the service fails to start:

```bash
sudo runuser -l ubuntu -c "cd /home/ubuntu/wety && /home/ubuntu/wety/target/release/server"
```

In general, a cheat sheet for managing the service:

```bash
# Start the wety service
sudo systemctl start wety

# Stop the wety service
sudo systemctl stop wety

# Restart the wety service
sudo systemctl restart wety

# Check the status of the wety service
sudo systemctl status wety

# Enable the wety service to start on boot
sudo systemctl enable wety

# Disable the wety service from starting on boot
sudo systemctl disable wety

# View the logs of the wety service
sudo journalctl -u wety

# Check the configuration of the wety service
sudo systemctl cat wety

# Reload the systemd daemon to apply any changes to unit files
sudo systemctl daemon-reload
```
